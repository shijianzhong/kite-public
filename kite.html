<!DOCTYPE html>
<html lang="en" x-bind:class="{ 'dark': darkMode }">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="theme-color" content="#ffffff" id="theme-color" />
        <title>Kite</title>
        <link rel="manifest" href="{{ static_path }}/manifest.json" />
        <link rel="icon" type="image/svg+xml" href="{{ static_path }}/svg/kite.svg" />
        <link rel="apple-touch-icon" href="{{ static_path }}/apple-touch-icon.png" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.4/Sortable.min.js"></script>
        <link rel="stylesheet" href="{{ static_path }}/kite.css?{{ timestamp }}" />
        <script>
            const timestamp = Date.now();
            let mediaData = null;

            // Load media data immediately
            fetch("{{ static_path }}/media_data.json")
                .then((response) => response.json())
                .then((data) => {
                    // Transform array into lookup object
                    const lookup = {};
                    data.forEach((item) => {
                        if (item.domains) {
                            item.domains.forEach((domain) => {
                                lookup[domain.toLowerCase()] = item;
                            });
                        }
                    });

                    mediaData = {
                        raw: data,
                        lookup: lookup,
                    };
                })
                .catch((error) => {
                    // Error handling for media data loading
                });
        </script>
        <link
            rel="alternate"
            :href="currentCategory === 'OnThisDay' ? 'https://en.wikipedia.org/w/api.php?action=featuredfeed&feed=onthisday' : currentCategory.toLowerCase() + '.xml'"
            type="application/rss+xml"
            :title="'Kagi News - ' + currentCategory"
        />
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {
                            dark: {
                                bg: "#1a202c",
                                text: "#e2e8f0",
                            },
                        },
                    },
                    fontSize: {
                        xs: "0.75rem", // 12px
                        sm: "0.875rem", // 14px
                        base: "1rem", // 16px
                        lg: "1.125rem", // 18px
                        xl: "1.35rem",
                        "2xl": "1.5rem",
                        "3xl": "1.8rem",
                        "4xl": "2rem",
                    },
                },
            };
            document.addEventListener("alpine:init", () => {                                                                                                                                                              
                Alpine.store("language", {
                    current: localStorage.getItem("language") || "en",
                    set(lang) {
                        this.current = lang;
                        localStorage.setItem("language", lang);
                        this.apply();
                    },
                    apply() {
                        // Force reload categories and stories
                        window.dispatchEvent(new CustomEvent('language-changed', { detail: this.current }));
                    },
                    init() {
                        if (!localStorage.getItem("language")) {
                            this.set("en");
                        }
                    }
                });
                Alpine.data("sourceOverlay", () => ({
                    showSourceOverlay: false,
                    currentSource: { name: "", favicon: "" },
                    sourceArticles: [],
                    currentStory: null,
                    mediaInfo: null,
                    showSourceInfo: false,

                    async processSource($event) {
                        if (!mediaData?.lookup) {
                            console.log("Media data not yet loaded, fetching...");
                            const response = await fetch("{{ static_path }}/media_data.json");
                            const data = await response.json();
                            const lookup = {};
                            data.forEach((item) => {
                                if (item.domains) {
                                    item.domains.forEach((domain) => {
                                        lookup[domain.toLowerCase()] = item;
                                    });
                                }
                            });
                            mediaData = {
                                raw: data,
                                lookup: lookup,
                            };
                        }

                        this.showSourceOverlay = true;
                        this.currentSource = $event.detail.domain || { name: "", favicon: "" };
                        this.currentStory = $event.detail.story || null;
                        this.sourceArticles = this.currentStory && this.currentSource?.name ? this.currentStory.articles.filter((a) => a.domain === this.currentSource.name) : [];

                        this.mediaInfo = null;
                        if (this.currentSource?.name) {
                            const lookupKey = this.currentSource.name.toLowerCase();
                            this.mediaInfo = mediaData?.lookup?.[lookupKey];
                        }

                        this.showSourceInfo = false;
                    },
                }));
                // Ensure media data is loaded
                if (!mediaData) {
                    fetch("{{ static_path }}/media_data.json")
                        .then((response) => response.json())
                        .then((data) => {
                            mediaData = data;
                        })
                        .catch((error) => {
                            console.error("Error loading media data:", error);
                        });
                }

                Alpine.store("intro", {
                    shown: localStorage.getItem("introShown") === "true",
                    set(value) {
                        this.shown = value;
                        localStorage.setItem("introShown", value);
                    },
                });

                Alpine.store("theme", {
                    current: localStorage.getItem("theme") || "system",
                    set(theme) {
                        this.current = theme;
                        localStorage.setItem("theme", theme);
                        this.apply();
                    },
                    apply() {
                        const isDark = this.current === "dark" || (this.current === "system" && window.matchMedia("(prefers-color-scheme: dark)").matches);
                        document.documentElement.classList.toggle("dark", isDark);
                        document.getElementById("theme-color").setAttribute("content", isDark ? "#1a202c" : "#ffffff");
                    },
                    init() {
                        this.apply();
                        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
                            if (this.current === "system") {
                                this.apply();
                            }
                        });
                    },
                });

                Alpine.store("fontSize", {
                    current: localStorage.getItem("fontSize") || "normal",
                    set(size) {
                        this.current = size;
                        localStorage.setItem("fontSize", size);
                        this.apply();
                    },
                    apply() {
                        document.body.classList.remove("text-sm", "text-base", "text-lg");
                        switch (this.current) {
                            case "small":
                                document.body.classList.add("text-sm");
                                break;
                            case "large":
                                document.body.classList.add("text-lg");
                                break;
                            default:
                                document.body.classList.add("text-base");
                        }
                    },
                    init() {
                        if (!localStorage.getItem("fontSize")) {
                            this.set("normal");
                        }
                        this.apply();
                    },
                });

                Alpine.store("sections", {
                    defaultOrder: [
                        "summary",
                        "primaryImage",
                        "highlights",
                        "quotes",
                        "secondaryImage",
                        "perspectives",
                        "historicalBackground",
                        "humanitarianImpact",
                        "technicalDetails",
                        "businessAngle",
                        "internationalReactions",
                        "otherDetails",
                        "timeline",
                        "sources",
                        "didYouKnow",
                        "actionItems"
                    ],
                    settings: {
                        summary: localStorage.getItem("showSummary") !== "false",
                        primaryImage: localStorage.getItem("showPrimaryImage") !== "false",
                        highlights: localStorage.getItem("showHighlights") !== "false",
                        quotes: localStorage.getItem("showQuotes") !== "false",
                        secondaryImage: localStorage.getItem("showSecondaryImage") !== "false",
                        perspectives: localStorage.getItem("showPerspectives") !== "false",
                        historicalBackground: localStorage.getItem("showHistoricalBackground") !== "false",
                        humanitarianImpact: localStorage.getItem("showHumanitarianImpact") !== "false",
                        technicalDetails: localStorage.getItem("showTechnicalDetails") !== "false",
                        businessAngle: localStorage.getItem("showBusinessAngle") !== "false",
                        internationalReactions: localStorage.getItem("showInternationalReactions") !== "false",
                        otherDetails: localStorage.getItem("showOtherDetails") !== "false",
                        timeline: localStorage.getItem("showTimeline") !== "false",
                        sources: localStorage.getItem("showSources") !== "false",
                        didYouKnow: localStorage.getItem("showDidYouKnow") !== "false",
                        actionItems: localStorage.getItem("showActionItems") !== "false"
                    },
                    order: JSON.parse(localStorage.getItem("sectionOrder")),
                    toggle(section) {
                        this.settings[section] = !this.settings[section];
                        localStorage.setItem("show" + section.charAt(0).toUpperCase() + section.slice(1), this.settings[section]);
                    },
                    init() {
                        if (!this.order) {
                            this.order = this.defaultOrder;
                        }
                        // Reset if there are new items, or the keys are different
                        if (this.order.length !== this.defaultOrder.length || Object.keys(this.order).some((key) => this.order[key] !== this.defaultOrder[key])) {
                            this.order = this.defaultOrder;
                            localStorage.setItem("sectionOrder", JSON.stringify(this.order));
                        }
                    },
                    render() {
                        const container = document.querySelector('[x-ref="sectionsList"]');
                        
                        // Clear existing content
                        container.innerHTML = '';
                        
                        // Create the initial items
                        Alpine.store('sections').order.forEach(sectionName => {
                            const div = document.createElement('div');
                            div.className = 'flex items-center justify-between';
                            div.dataset.section = sectionName;
                            div.innerHTML = `
                                <div class='flex items-center'>
                                    <svg class='w-6 h-6 text-gray-400 mr-3 cursor-move drag-handle' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 6h16M4 12h16M4 18h16'></path>
                                    </svg>
                                    <label class='text-sm font-medium text-gray-700 dark:text-gray-300'>
                                        ${sectionName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}
                                    </label>
                                </div>
                                <button x-data 
                                        @click="$store.sections.toggle('${sectionName}')" 
                                        class="relative inline-flex h-6 w-11 items-center rounded-full"
                                        :class="$store.sections.settings['${sectionName}'] ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-700'">
                                    <span class='sr-only'>Toggle ${sectionName}</span>
                                    <span class='inline-block h-4 w-4 transform rounded-full bg-white transition'
                                        :class="$store.sections.settings['${sectionName}'] ? 'translate-x-6' : 'translate-x-1'"></span>
                                </button>
                            `;
                            container.appendChild(div);
                        });

                        // Initialize Sortable
                        new Sortable(container, {
                            animation: 150,
                            handle: '.drag-handle',
                            onEnd: function(evt) {
                                const newOrder = Array.from(evt.to.children)
                                    .map(el => el.dataset.section)
                                    .filter(Boolean);
                                
                                Alpine.store('sections').order = newOrder;
                                localStorage.setItem("sectionOrder", JSON.stringify(newOrder));
                            }
                        });
                    },
                    reset() {
                        this.order = this.defaultOrder;
                        localStorage.setItem("sectionOrder", JSON.stringify(this.defaultOrder));

                        this.render();
                    }
                });

                Alpine.store("chaosIndex", {
                    score: 0,
                    summary: "",
                    getBucketDescription() {
                        const score = this.score;
                        if (score >= 0 && score <= 20) {
                            return "0-20: Peaceful and calm world. Yay!";
                        } else if (score >= 21 && score <= 40) {
                            return "21-40: Emerging challenges, manageable tensions.";
                        } else if (score >= 41 && score <= 60) {
                            return "41-60: Growing global issues, but hope persists.";
                        } else if (score >= 61 && score <= 80) {
                            return "61-80: Multiple crises, increasing instability.";
                        } else if (score >= 81 && score <= 100) {
                            return "81-100: Severe global turmoil, widespread impact.";
                        } else {
                            return "Undefined score range";
                        }
                    },
                });

                Alpine.store("storyCount", {
                    current: parseInt(localStorage.getItem("storyCount")) || 10,
                    set(count) {
                        this.current = count;
                        localStorage.setItem("storyCount", count);
                    },
                    init() {
                        if (this.current < 3) this.current = 3;
                        if (this.current > 12) this.current = 12;
                    },
                });

                Alpine.store("categories", {
                    order: [],
                    enabled: [],
                    isValidCategory(category){
                        return category != null && category !== undefined && category !== "";
                    },
                    init() {
                        window.addEventListener('language-changed', () => {
                            this.order = [];
                            this.enabled = [];
                            localStorage.removeItem("categoryOrder");
                            localStorage.removeItem("enabledCategories");

                            console.log("[init] Language changed, reloading");

                            // TODO: Remove this once we make it work without refreshing
                            window.location.reload();
                        });

                        const savedOrder = JSON.parse(localStorage.getItem("categoryOrder"));
                        const savedEnabled = JSON.parse(localStorage.getItem("enabledCategories"));
                        if (savedOrder) {
                            this.order = savedOrder.filter((cat) => this.isValidCategory(cat));
                        }
                        if (savedEnabled) {
                            // Reorder enabled categories to match the order in categoryOrder and filter out null values
                            this.enabled = this.order.filter((cat) => this.isValidCategory(cat) && savedEnabled.includes(cat));
                        }
                        // Save the cleaned up enabled categories
                        localStorage.setItem("enabledCategories", JSON.stringify(this.enabled));

                        // Dispatch event when categories are loaded
                        window.dispatchEvent(new CustomEvent('categories-loaded'));
                    },
                    saveNewOrder(newOrder) {
                        this.order = newOrder.filter((cat) => this.isValidCategory(cat));
                        // Don't modify enabled categories here - let the Sortable handler manage that
                        localStorage.setItem("categoryOrder", JSON.stringify(this.order));
                        localStorage.setItem("enabledCategories", JSON.stringify(this.enabled));
                    },
                    enableCategory(category) {
                        const index = this.enabled.indexOf(category);
                        // if (index > -1) {
                        //     console.log("[enableCategory] Category already enabled, removing");
                        //     if (this.enabled.length > 1) {
                        //         this.enabled.splice(index, 1);
                        //     }
                        // } else {
                            // When enabling a category, insert it in the correct position according to order
                            const orderIndex = this.order.indexOf(category);
                            const insertIndex = this.enabled.findIndex((cat) => this.order.indexOf(cat) > orderIndex);
                            if (insertIndex === -1) {
                                this.enabled.push(category);
                            } else {
                                this.enabled.splice(insertIndex, 0, category);
                            }
                        // }

                        localStorage.setItem("enabledCategories", JSON.stringify(this.enabled));
                        console.log("[enableCategory] Saving enabled categories:", this.enabled);
                    },
                    isEnabled(category) {
                        return this.enabled.includes(category);
                    },
                });

                Alpine.store("imageGallery", {
                    swiper: null,
                    isOpen: false,
                    images: [],
                    open(images) {
                        this.images = images;
                        this.isOpen = true;
                        document.body.classList.add("overflow-hidden");
                        setTimeout(() => {
                            this.swiper = initializeSwiper(".swiper-container");
                        }, 0);
                    },
                    close() {
                        this.isOpen = false;
                        document.body.classList.remove("overflow-hidden");
                        if (this.swiper) {
                            this.swiper.destroy();
                            this.swiper = null;
                        }
                    },
                });

                Alpine.store("settings", {
                    isOpen: false,
                    open() {
                        this.isOpen = true;
                        document.body.classList.add("overflow-hidden");
                    },
                    close() {
                        this.isOpen = false;
                        document.body.classList.remove("overflow-hidden");
                    },
                });

                Alpine.store("mobileUI", {
                    categoryHeaderPosition: localStorage.getItem("categoryHeaderPosition") || "bottom",
                    setCategoryHeaderPosition(position) {
                        this.categoryHeaderPosition = position;
                        localStorage.setItem("categoryHeaderPosition", position);
                    }
                });

            });
            function lockScroll() {
                document.body.style.overflow = "hidden";
            }

            function unlockScroll() {
                document.body.style.overflow = "";
            }

            function findScrollableParent(element) {
                if (!element) return null;
                
                // Check if the element itself is scrollable
                if (isElementScrollable(element)) {
                    return element;
                }
                
                // Check parent elements
                let parent = element.parentElement;
                while (parent) {
                    if (isElementScrollable(parent)) {
                        return parent;
                    }
                    parent = parent.parentElement;
                }
                
                return null;
            }
            
            function isElementScrollable(element) {
                const style = window.getComputedStyle(element);
                const overflowX = style.getPropertyValue('overflow-x');
                
                // Check if element has horizontal scroll
                return (overflowX === 'auto' || overflowX === 'scroll') && 
                       element.scrollWidth > element.clientWidth;
            }

            function fetchChaosIndex() {
                // Disabled chaos index loading
                return;
            }

            function generateArticleId(category, clusterNumber) {
                return `${category.toLowerCase()}-${clusterNumber}`;
            }

            function updateUrlWithArticleId(articleId) {
                const url = new URL(window.location);
                if (articleId) {
                    url.searchParams.set("article", articleId);
                } else {
                    url.searchParams.delete("article");
                    // If there are no more parameters, remove the '?' entirely
                    if (Array.from(url.searchParams).length === 0) {
                        window.history.pushState({}, "", window.location.pathname);
                        return;
                    }
                }
                window.history.pushState({}, "", url);
            }

            function getArticleIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get("article");
            }

            function formatTimeSince(timestamp) {
                const diff = Math.floor(Date.now() / 1000 - timestamp);
                if (diff < 60) {
                    return `Updated ${diff} sec ago`;
                } else if (diff < 3600) {
                    const mins = Math.floor(diff / 60);
                    return `Updated ${mins} ${mins === 1 ? "min" : "mins"} ago`;
                } else {
                    const hours = Math.floor(diff / 3600);
                    return `Updated ${hours} ${hours === 1 ? "hour" : "hours"} ago`;
                }
            }

            function handleWikiLink(event) {
                const link = event.target.closest('a[href^="https://en.wikipedia.org/wiki/"]');
                if (link) {
                    event.preventDefault();
                    const title = decodeURIComponent(link.getAttribute("href").split("/").pop());
                    const apiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;

                    fetch(apiUrl)
                        .then((response) => response.json())
                        .then((data) => {
                            const isMobile = window.innerWidth <= 768;
                            console.log('isMobile', isMobile);
                            if (isMobile) {
                                // For mobile, show a full-screen modal
                                const popup = document.createElement('div');
                                popup.className = 'fixed inset-0 z-50 bg-white dark:bg-gray-800 overflow-y-auto';
                                popup.innerHTML = `
                                    <div class="p-4">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">${data.title}</h3>
                                            <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" onclick="this.parentElement.parentElement.parentElement.remove()">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        ${data.thumbnail ? `
                                            <div class="relative h-48 w-full mb-4">
                                                <img src="${data.thumbnail.source}" alt="${data.title}" class="w-full h-full object-cover rounded-lg"/>
                                            </div>
                                        ` : ''}
                                        <div class="prose prose-sm dark:prose-invert max-w-none">
                                            <p>${data.extract}</p>
                                        </div>
                                        <div class="mt-4">
                                            <a href="${link.href}" target="_blank" class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:underline">
                                                <span>Read more on Wikipedia</span>
                                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                </svg>
                                            </a>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(popup);
                            } else {
                                // For desktop, keep the hover popup
                                showPopup(data, link);
                            }
                        })
                        .catch((error) => {
                            console.error("Error fetching Wikipedia summary:", error);
                        });
                }
            }

            function showPopup(data, link) {
                const popup = document.getElementById("wikipedia-popup");
                const popupContent = document.getElementById("wikipedia-popup-content");
                const popupImage = document.getElementById("wikipedia-popup-image");
                const popupLayout = document.getElementById("wikipedia-popup-layout");
                const closeButton = document.getElementById("wikipedia-popup-close");

                popupContent.textContent = data.extract;

                if (data.thumbnail) {
                    popupImage.src = data.thumbnail.source;
                    popupImage.style.display = "block";
                } else {
                    popupImage.style.display = "none";
                }

                popupLayout.classList.remove("flex-row");
                popupLayout.classList.add("flex-col");
                popupImage.classList.add("mb-4");
                popupImage.classList.remove("mr-4");
                popupImage.style.width = "100%";
                popupImage.style.height = "auto";
                popupImage.style.objectFit = "scale-down";

                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    popup.style.position = "fixed";
                    popup.style.left = "0";
                    popup.style.right = "0";
                    popup.style.top = "0";
                    popup.style.width = "100%";
                    popup.style.maxWidth = "100%";
                    popup.style.height = "80vh";
                    popup.style.maxHeight = "80vh";
                    popup.style.margin = "0";
                    popup.style.borderRadius = "0";
                    popup.style.overflowY = "auto";
                    closeButton.style.display = "block";
                } else {
                    const rect = link.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    const popupWidth = 400;
                    const popupHeight = 400;

                    let leftPosition = rect.left + window.scrollX;
                    let topPosition = rect.bottom + window.scrollY;

                    if (leftPosition + popupWidth > viewportWidth) {
                        leftPosition = Math.max(viewportWidth - popupWidth - 10, 0);
                    }

                    if (topPosition + popupHeight > viewportHeight + window.scrollY) {
                        topPosition = Math.max(rect.top + window.scrollY - popupHeight, window.scrollY);
                    }

                    popup.style.position = "absolute";
                    popup.style.left = `${leftPosition}px`;
                    popup.style.top = `${topPosition}px`;
                    popup.style.width = `${popupWidth}px`;
                    popup.style.height = `${popupHeight}px`;
                    popup.style.borderRadius = "0.5rem";
                    closeButton.style.display = "none";
                }

                popup.style.display = "block";
            }

            function openImageGallery(images) {
                Alpine.store("imageGallery").open(images);
            }
            document.addEventListener("alpine:init", () => {
                Alpine.data("kiteApp", () => ({
                    stories: [],
                    expandedStory: null,
                    initialLoading: true,
                    mediaData: [],
                    isScrolling: false,
                    readStories: JSON.parse(localStorage.getItem("readStories") || "{}"),
                    totalStoriesRead: parseInt(localStorage.getItem("totalStoriesRead") || "0"),
                    availableCategories: [],
                    currentCategory: "",
                    timestamp: 0,
                    readCount: 0,
                    dateClickCount: 0,
                    allStories: {},
                    onThisDayEvents: [],
                    showIntro: !Alpine.store("intro").shown && !getArticleIdFromUrl(),
                    chaosScore: 0,
                    chaosSummary: "",
                    viewMode: "list",
                    sortableInstance: null,
                    loadingProgress: 0,
                    getLastUpdated() {
                        return formatTimeSince(this.timestamp);
                    },
                    openMaps(location) {
                        const encodedLocation = encodeURIComponent(location);
                        const appleUrl = `maps://maps.apple.com/?q=${encodedLocation}`;
                        const googleUrl = `maps:?q=${encodedLocation}`;
                        const googleWebUrl = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;

                        const isMacOSOrIOS = /Mac|iPhone|iPad|iPod/.test(navigator.platform);

                        if (isMacOSOrIOS) {
                            window.location.href = appleUrl;

                            setTimeout(() => {
                                if (document.hidden) return;
                                window.location.href = googleUrl;
                            }, 500);
                        } else {
                            window.location.href = googleUrl;

                            setTimeout(() => {
                                if (document.hidden) return;
                                window.location.href = googleWebUrl;
                            }, 500);
                        }
                    },
                    allStoriesRead: false,
                    markAllAsRead() {
                        // Mark all stories in current category as read
                        this.stories.forEach(story => {
                            if (!this.readStories[story.title]) {
                                this.readStories[story.title] = true;
                                this.totalStoriesRead++;
                            }
                        });
                        // Update localStorage
                        localStorage.setItem("readStories", JSON.stringify(this.readStories));
                        localStorage.setItem("totalStoriesRead", this.totalStoriesRead);
                        // Hide the button
                        this.allStoriesRead = true;
                    },
                    touchStartX: 0,
                    touchEndX: 0,
                    touchStartY: 0,
                    touchEndY: 0,
                    touchStartedOnScrollable: false,
                    async init() {
                        // Add language change event listener
                        window.addEventListener('language-changed', () => {
                            this.initialLoading = true;
                            this.fetchCategories()
                                .then(() => this.fetchAllStories())
                                .finally(() => {
                                    this.initialLoading = false;
                                });
                        });

                        Alpine.store("language").init();

                        // Check if all stories are read
                        this.allStoriesRead = this.stories.every(story => this.readStories[story.title]);

                        // Load media data
                        try {
                            const response = await fetch("{{ static_path }}/media_data.json");
                            if (response.ok) {
                                this.mediaData = await response.json();
                            }
                        } catch (error) {
                            console.error("Error loading media data:", error);
                            this.mediaData = [];
                        }

                        this.fetchCategories()
                            .then(() => {
                                return this.fetchAllStories();
                            })
                            .then(() => {
                                const storedOrder = Alpine.store("categories").order || [];
                                const storedEnabled = Alpine.store("categories").enabled || [];
                                const allCategoryNames = this.availableCategories.map((cat) => cat.name);

                                // For new users (no stored order or enabled categories), set defaults
                                if (!storedOrder || storedOrder.length === 0 || !storedEnabled || storedEnabled.length === 0) {
                                    const defaultCategories = ["World", "OnThisDay", "Business", "Technology", "Science", "Sports"];
                                    Alpine.store("categories").order = allCategoryNames;
                                    Alpine.store("categories").enabled = defaultCategories.filter((name) => allCategoryNames.includes(name));
                                    this.currentCategory = "World";
                                } else {
                                    this.currentCategory = storedOrder[0];
                                    // For existing users, update order and enabled categories
                                    const newCategories = allCategoryNames.filter((name) => !storedOrder.includes(name));
                                    Alpine.store("categories").order = storedOrder.concat(newCategories);

                                    // Remove categories from order that no longer exist
                                    Alpine.store("categories").order = Alpine.store("categories").order.filter((name) => allCategoryNames.includes(name));

                                    // Keep their enabled categories that still exist
                                    Alpine.store("categories").enabled = storedEnabled.filter((name) => allCategoryNames.includes(name));
                                }

                                // Rebuild availableCategories according to the updated order
                                this.availableCategories = Alpine.store("categories")
                                    .order.map((name) => this.availableCategories.find((cat) => cat.name === name))
                                    .filter((cat) => cat);

                                // Save the updated order and enabled categories back to localStorage
                                localStorage.setItem("categoryOrder", JSON.stringify(Alpine.store("categories").order));
                                localStorage.setItem("enabledCategories", JSON.stringify(Alpine.store("categories").enabled));

                                // Set current category to the first enabled category
                                const firstEnabledCategory = Alpine.store("categories").enabled[0];
                                if (firstEnabledCategory) {
                                    this.currentCategory = firstEnabledCategory;
                                }

                                this.changeCategory();
                                this.updateCategoryDropdown();
                                this.renderCategories();
                                Alpine.store("categories").init();

                                window.dispatchEvent(new CustomEvent('categories-loaded'));

                                this.initCategorySortable();
                                const articleId = getArticleIdFromUrl();
                                if (articleId) {
                                    this.openSharedArticle(articleId);
                                }
                            });

                        Alpine.store("theme").init();
                        Alpine.store("fontSize").init();
                        Alpine.store("storyCount").init();
                        Alpine.store("sections").init();

                        fetchChaosIndex();
                    },
                    fetchCategories() {
                        const lang = Alpine.store("language").current;
                        const filename = lang === 'en' ? 'kite.json' : `kite_${lang}.json`;
                        
                        // Reset categories before fetching
                        this.availableCategories = [];
                        this.currentCategory = "";
                        
                        return fetch(`{{ base_path }}${filename}?${Date.now()}`)
                            .then((response) => response.json())
                            .then((data) => {
                                this.availableCategories = data.categories;
                                this.timestamp = data.timestamp;
                            });
                    },
                    fetchAllStories() {
                        this.initialLoading = true;
                        this.allStories = {};
                        this.currentCategory = "";
                        this.totalReadCount = 0;
                        const totalCategories = this.availableCategories.length;
                        let loadedCategories = 0;

                        const fetchPromises = this.availableCategories.map((category) =>
                            fetch(`{{ base_path }}${category.file}?${Date.now()}`)
                                .then((response) => response.json())
                                .then((data) => {
                                    if (category.name === "OnThisDay") {
                                        this.onThisDayEvents = data.events;
                                    } else {
                                        this.allStories[category.name] = {
                                            clusters: data.clusters,
                                            readCount: data.read,
                                        };
                                        this.totalReadCount += data.read;
                                    }
                                    loadedCategories++;
                                    this.loadingProgress = Math.round((loadedCategories / totalCategories) * 100);
                                })
                        );

                        return Promise.all(fetchPromises)
                            .then(() => {
                                this.initialLoading = false;
                            })
                            .catch((error) => {
                                console.error("Error fetching stories:", error);
                                this.initialLoading = false;
                            });
                    },
                    initCategorySortable() {
                        const enabledContainer = document.querySelector('[x-ref="enabledCategories"]');
                        new Sortable(enabledContainer, {
                            animation: 150,
                            ghostClass: "bg-blue-600",
                            swapThreshold: 0.5,
                            onStart: (evt) => {
                                enabledContainer.classList.add('is-dragging');
                            },
                            onEnd: (evt) => {
                                enabledContainer.classList.remove('is-dragging');

                                const newEnabledOrder = Array.from(evt.to.children)
                                    .map(el => el.dataset.category)
                                    .filter(Boolean);
                                
                                this.updateCategoryOrders(newEnabledOrder);
                            }
                        });
                    },
                    renderCategories() {
                        const enabledContainer = document.querySelector('[x-ref="enabledCategories"]');
                        const disabledContainer = document.querySelector('[x-ref="disabledCategories"]');
                        
                        // Clear existing content more aggressively
                        if (enabledContainer) enabledContainer.innerHTML = '';
                        if (disabledContainer) disabledContainer.innerHTML = '';
                        
                        const categoriesStore = Alpine.store('categories');
                        const self = this;
                        
                        // Clear existing content
                        enabledContainer.innerHTML = '';
                        disabledContainer.innerHTML = '';
                        
                        function createCategoryElement(categoryName, isEnabled) {
                            const div = document.createElement('div');
                            div.className = `px-6 py-3 rounded-lg text-sm cursor-pointer font-medium inline-flex items-center whitespace-nowrap ${
                                isEnabled 
                                    ? 'bg-blue-500 text-white shadow-sm [.is-dragging_&]:bg-blue-500 [&.sortable-chosen]:!bg-blue-600 hover:bg-blue-600' 
                                    : 'bg-gray-100 dark:bg-gray-200 text-gray-700 dark:text-gray-800 hover:bg-gray-200 dark:hover:bg-gray-300'
                            }`;
                            div.dataset.category = categoryName;

                            // Create inner span for text
                            const span = document.createElement('span');
                            span.textContent = categoryName === 'OnThisDay' ? 'Today in History' : categoryName;
                            div.appendChild(span);

                            // Use pointer workaround instead of click to avoid mobile browser issues
                            let startTime = 0;
                            div.addEventListener('pointerdown', (e) => {
                                startTime = Date.now();
                            });

                            div.addEventListener('pointerup', (e) => {
                                // Only trigger click if the pointer was down for less than 200ms (distinguishes from drag)
                                if (Date.now() - startTime < 200) {
                                self.handleCategoryClick(categoryName);
                                }
                            });

                            return div;
                        }

                        // Render enabled categories
                        categoriesStore.enabled.forEach(categoryName => {
                            enabledContainer.appendChild(createCategoryElement(categoryName, true));
                        });
                        
                        // Render disabled categories
                        this.availableCategories
                            .map((cat) => cat.name)
                            .filter(cat => !categoriesStore.enabled.includes(cat))
                            .forEach(categoryName => {
                                disabledContainer.appendChild(createCategoryElement(categoryName, false));
                            });
                    },
                    updateCategoryOrders(newEnabledOrder) {
                        const categoriesStore = Alpine.store("categories");
                        const currentOrder = categoriesStore.order;

                        // Update enabled categories
                        categoriesStore.enabled = [...newEnabledOrder];

                        // Create new full order maintaining positions
                        const newFullOrder = [
                            ...newEnabledOrder,
                            ...currentOrder.filter(cat => !newEnabledOrder.includes(cat))
                        ];
                        categoriesStore.order = newFullOrder;

                        // Update localStorage
                        categoriesStore.saveNewOrder(newFullOrder);

                        // Update available categories
                        this.availableCategories = newFullOrder
                            .map(catName => this.availableCategories.find(cat => cat.name === catName))
                            .filter(Boolean);
                    },
                    handleCategoryClick(category) {
                        const categoriesStore = Alpine.store("categories");
                        if (!categoriesStore.enabled.includes(category)) {
                            categoriesStore.enableCategory(category);
                        }
                        else if(categoriesStore.enabled.length > 1 && categoriesStore.enabled.includes(category)){
                            categoriesStore.enabled = categoriesStore.enabled.filter(cat => cat !== category);
                            if (category === this.currentCategory) { // If user disables current category, set to first enabled category
                                this.currentCategory = categoriesStore.enabled[0];
                                this.changeCategory();
                            }
                        }

                        localStorage.setItem("enabledCategories", JSON.stringify(categoriesStore.enabled));
                        
                        this.updateCategoryDropdown();
                        this.renderCategories();

                    },
                    updateCategoryDropdown() {
                        const select = document.getElementById("category-select");
                        if (!select) {
                            return;
                        }

                        const enabledCategories = Alpine.store("categories").enabled;

                        while (select.firstChild) {
                            select.removeChild(select.firstChild);
                        }

                        // Use the stored order for enabled categories
                        enabledCategories.forEach((catName) => {
                            if (catName) {
                                const option = document.createElement("option");
                                option.value = catName;
                                option.textContent = catName === "OnThisDay" ? "Today in History" : catName;
                                select.appendChild(option);
                            }
                        });
                    },
                    closeIntro() {
                        this.showIntro = false;
                        Alpine.store("intro").set(true);
                    },
                    toggleStory(story, index) {
                        if (this.expandedStory === story) {
                            console.log("Collapsing story", story);
                            // Collapse the story
                            story.expanded = false;
                            this.expandedStory = null;
                            updateUrlWithArticleId("");
                            story.showSources = false;
                            // Do not call scrollToStory when collapsing
                        } else {
                            console.log("Expanding story", story);
                            if (this.expandedStory && this.expandedStory !== story) {
                                this.expandedStory.expanded = false;
                                this.expandedStory.showSources = false;
                            }
                            // Expand the story
                            if (!this.readStories[story.title]) {
                                this.readStories[story.title] = true;
                                localStorage.setItem("readStories", JSON.stringify(this.readStories));
                                this.totalStoriesRead++;
                                localStorage.setItem("totalStoriesRead", this.totalStoriesRead);
                            }
                            story.expanded = true;
                            this.expandedStory = story;
                            const articleId = generateArticleId(this.currentCategory, story.cluster_number);
                            updateUrlWithArticleId(articleId);
                            story.showSources = false;
                            // Call scrollToStory after expanding
                            this.$nextTick(() => {
                                this.scrollToStory(index);
                            });
                        }
                    },
                    closeStory(story, index) {
                        // Collapse the story
                        story.expanded = false;
                        this.expandedStory = null;
                        updateUrlWithArticleId("");
                        story.showSources = false;
                        // Scroll to the collapsed story
                        this.$nextTick(() => {
                            this.scrollToStory(index);
                        });
                    },
                    scrollToStory(index) {
                        setTimeout(() => {
                            const storyElement = document.getElementById("story-" + index);
                            if (storyElement) {
                                const stickyElement = document.querySelector(".sticky");
                                const navHeight = stickyElement ? stickyElement.offsetHeight : 0;
                                const yOffset = -navHeight;
                                const y = storyElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
                                window.scrollTo({ top: y, behavior: "smooth" });
                            }
                        }, 100);
                    },
                    openSharedArticle(articleId) {
                        const [category, clusterNumber] = articleId.split("-");
                        // Handle multi-word categories by capitalizing each word
                        const targetCategory = category
                            .split("+")
                            .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(" ");

                        // Wait for stories to be loaded
                        const checkAndOpenStory = () => {
                            if (this.allStories[targetCategory]) {
                                // Set current category first
                                this.currentCategory = targetCategory;

                                // Make sure the category is enabled
                                if (!Alpine.store("categories").enabled.includes(targetCategory)) {
                                    Alpine.store("categories").enableCategory(targetCategory);
                                }

                                // Update category dropdown and UI
                                this.updateCategoryDropdown();
                                this.changeCategory();

                                // Find and open the story
                                const story = this.allStories[targetCategory].clusters.find((s) => s.cluster_number === parseInt(clusterNumber));

                                if (story) {
                                    // Ensure the story is in the visible stories array
                                    this.stories = this.allStories[targetCategory].clusters.slice(0, this.$store.storyCount.current);

                                    // Expand the story
                                    story.expanded = true;
                                    this.expandedStory = story;

                                    // Scroll to the story after a short delay to ensure DOM is updated
                                    this.$nextTick(() => {
                                        const storyIndex = this.stories.findIndex((s) => s.cluster_number === story.cluster_number);
                                        if (storyIndex !== -1) {
                                            setTimeout(() => {
                                                this.scrollToStory(storyIndex);
                                            }, 200);
                                        }
                                    });
                                } else {
                                    console.warn(`Story with cluster number ${clusterNumber} not found in ${targetCategory}`);
                                }
                            } else {
                                // If stories aren't loaded yet, try again in 100ms
                                setTimeout(checkAndOpenStory, 100);
                            }
                        };

                        // Start checking for stories
                        checkAndOpenStory();
                    },
                    shareArticle(story) {
                        const articleId = generateArticleId(this.currentCategory, story.cluster_number);
                        const url = new URL(window.location);
                        url.searchParams.set("article", articleId);

                        if (navigator.share) {
                            navigator
                                .share({
                                    title: story.title,
                                    text: "Check out this story:",
                                    url: url.toString(),
                                })
                                .catch(() => {
                                    navigator.clipboard.writeText(url.toString());
                                });
                        } else {
                            navigator.clipboard.writeText(url.toString());
                        }
                    },
                    changeCategory() {
                        // Close any expanded story
                        if (this.expandedStory) {
                            this.expandedStory.expanded = false;
                            this.expandedStory = null;
                            updateUrlWithArticleId("");
                        }

                        window.scrollTo({ top: 0, behavior: "smooth" });
                        if (this.availableCategories.length > 0) {
                            let enabledCategories = Alpine.store("categories").enabled;
                            if (enabledCategories.length === 0 || !enabledCategories.includes(this.currentCategory)) {
                                this.availableCategories.forEach((cat) => Alpine.store("categories").enableCategory(cat.name));
                                enabledCategories = Alpine.store("categories").enabled;
                            }

                            // Ensure current category is valid and load its stories
                            if (!enabledCategories.includes(this.currentCategory)) {
                                this.currentCategory = enabledCategories[0];
                            }

                            if (this.currentCategory === "OnThisDay") {
                                this.stories = this.onThisDayEvents;
                            } else if (this.allStories[this.currentCategory]) {
                                const allClusters = this.allStories[this.currentCategory].clusters;
                                const unreadClusters = allClusters.filter((story) => !this.readStories[story.title]);
                                const readClusters = allClusters.filter((story) => this.readStories[story.title]);

                                // Take unread stories up to the limit
                                const unreadToShow = unreadClusters.slice(0, this.$store.storyCount.current);

                                // Combine unread and read stories
                                this.stories = [...unreadToShow, ...readClusters];
                                this.readCount = this.allStories[this.currentCategory].readCount;
                            }
                        }
                    },
                }));
            });


            // Example story: Proxy(Object) {year: '1849', content: '<b><a href="https://en.wikipedia.org/wiki/Joseph_FFavre">Joseph Favre</a></b> was born on this day.', sort_year: 1849.1}
            function fetchWikiImage(story) {
                // Extract the Wikipedia URL from the link
                const linkMatch = story.content.match(/<a href="([^"]+)"[^>]*>[^<]+<\/a>/);
                if (!linkMatch) {
                    console.log("No Wikipedia link found for", story);
                    return;
                }

                const wikipediaUrl = linkMatch[1];
                const title = decodeURIComponent(wikipediaUrl.split("/wiki/")[1]);
                console.log("Fetching image for", title);

                // Fetch Wikipedia summary for the image
                const apiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
                
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.thumbnail) {
                            story.image = data.thumbnail.source;
                            console.log("Image found for", title, data.thumbnail.source);
                        } else {
                            console.log("No image found for", title, "Data:", data);
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching Wikipedia image:", error);
                    });
            }

            function peopleCarousel(allStories) {
                return {
                peopleStories: [],   // all filtered stories (for mobile)
                chunkedStories: [],  // grouped into slides of 3 (for desktop)
                currentSlide: 0,     // which slide is active?
                lastScrollTime: 0,   // last time the user scrolled

                init() {
                    // 1) Filter only stories with "was born" or "died"
                    const filtered = allStories.filter(e => 
                    e.content.toLowerCase().includes('was born') ||
                    e.content.toLowerCase().includes(' died')
                    );

                    // Fetch Wikipedia image for each story
                    filtered.forEach(story => {
                    fetchWikiImage(story);
                    });

                    this.peopleStories = filtered;

                    // 2) Chunk them in groups of 3 for the desktop carousel
                    for (let i = 0; i < filtered.length; i += 3) {
                    this.chunkedStories.push(filtered.slice(i, i + 3));
                    }
                },

                // Move to the next slide
                nextSlide() {
                    if (this.currentSlide < this.chunkedStories.length - 1) {
                    this.currentSlide++;
                    }
                },

                // Move to the previous slide
                prevSlide() {
                    if (this.currentSlide > 0) {
                    this.currentSlide--;
                    }
                },

                // Jump to a particular slide
                goToSlide(index) {
                    this.currentSlide = index;
                },

                // Handle scroll on desktop
                onWheel(e) {
                    // Prevent default so the page doesn't scroll vertically
                    e.preventDefault();
                    if(Date.now() - this.lastScrollTime < 150) {
                        return;
                    }
                    
                    // If user scrolls "down" (deltaY > 0), go next. If "up" (deltaY < 0), go prev.
                    if (e.deltaY > 0 || e.deltaX > 0) {
                        this.nextSlide();
                        this.lastScrollTime = Date.now();
                    } else if (e.deltaY < 0 || e.deltaX < 0) {
                        this.prevSlide();
                        this.lastScrollTime = Date.now();
                    }
                    
                }
                }
            }

            document.addEventListener("pointerover", (event) => {
                const link = event.target.closest('a[href^="https://en.wikipedia.org/wiki/"]');
                if (link && window.innerWidth > 768) { // Only show hover popup on desktop
                    event.preventDefault();
                    const title = decodeURIComponent(link.getAttribute("href").split("/").pop());
                    const apiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
                    fetch(apiUrl)
                        .then((response) => response.json())
                        .then((data) => {
                            showPopup(data, link);
                        })
                        .catch((error) => {
                            console.error("Error fetching Wikipedia summary:", error);
                        });
                }
            });

            document.addEventListener("pointerout", (event) => {
                if (!event.target.closest('a[href^="https://en.wikipedia.org/wiki/"]') && !event.target.closest("#wikipedia-popup") && window.innerWidth > 768) {
                    document.getElementById("wikipedia-popup").style.display = "none";
                }
            });

            // Handle Wikipedia links for mobile
            document.addEventListener("click", (event) => {
                const link = event.target.closest('a[href^="https://en.wikipedia.org/wiki/"]');
                if (link && window.innerWidth <= 768) {
                    event.preventDefault();
                    const title = decodeURIComponent(link.getAttribute("href").split("/").pop());
                    const apiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
                    
                    fetch(apiUrl)
                        .then((response) => response.json())
                        .then((data) => {
                            const popup = document.createElement('div');
                            popup.className = 'fixed inset-0 z-[100] bg-white dark:bg-gray-800 overflow-y-auto';
                            popup.innerHTML = `
                                <div class="p-4 relative z-[101]">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">${data.title}</h3>
                                        <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" onclick="this.parentElement.parentElement.parentElement.remove()">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    ${data.thumbnail ? `
                                        <div class="relative h-48 w-full mb-4">
                                            <img src="${data.thumbnail.source}" alt="${data.title}" class="w-full h-full object-cover rounded-lg"/>
                                        </div>
                                    ` : ''}
                                    <div class="prose prose-sm dark:prose-invert max-w-none">
                                        <p>${data.extract}</p>
                                    </div>
                                    <div class="mt-4">
                                        <a href="${link.href}" target="_blank" class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:underline">
                                            <span>Read more on Wikipedia</span>
                                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(popup);
                        });
                }
            });
        </script>
    </head>

    <body
        class="min-h-screen bg-white dark:bg-dark-bg text-black dark:text-dark-text"
        x-data="Object.assign(kiteApp(), sourceOverlay())"
        x-bind:class="[
            $store.fontSize.current === 'extra-small' ? 'text-xs' : 
            $store.fontSize.current === 'small' ? 'text-sm' : 
            $store.fontSize.current === 'large' ? 'text-lg' : 'text-base',
            $store.mobileUI.categoryHeaderPosition === 'top' ? 'pt-14 md:pt-0' : ''
        ]"
        @touchstart="
            touchStartX = $event.changedTouches[0].screenX; 
            touchStartY = $event.changedTouches[0].screenY;
            
            // Check if touch started on a scrollable element
            const target = $event.target;
            const scrollableParent = findScrollableParent(target);
            touchStartedOnScrollable = scrollableParent && 
                                      (scrollableParent.scrollWidth > scrollableParent.clientWidth);
        "
        @touchend="
            if (touchStartedOnScrollable) {
                // Don't change category if touch started on a scrollable element
                return;
            }
            
            // Check if the touch started on or within the category tabs
            const categoryTabs = document.querySelector('.category-tabs');
            if (categoryTabs && (categoryTabs.contains($event.target) || categoryTabs === $event.target)) {
                return;
            }
            
            touchEndX = $event.changedTouches[0].screenX;
            touchEndY = $event.changedTouches[0].screenY;
            const deltaX = touchStartX - touchEndX;
            const deltaY = touchStartY - touchEndY;

            if(Math.abs(deltaY) > Math.abs(deltaX)) {
                return;
            }

            if (Math.abs(deltaX) > 50) {
                const categories = Array.from($store.categories.enabled);
                const currentIndex = categories.indexOf(currentCategory);
                if (deltaX > 0 && currentIndex < categories.length - 1) {
                    currentCategory = categories[currentIndex + 1];
                    changeCategory();
                } else if (deltaX < 0 && currentIndex > 0) {
                    currentCategory = categories[currentIndex - 1];
                    changeCategory();
                }

                // Scroll the selected category into view
                $nextTick(() => {
                    const selectedTab = document.querySelector('.category-tab.active');
                    if (selectedTab) {
                        selectedTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                });
            }
        "
    >
        <!-- Wikipedia Popup -->
        <div id="wikipedia-popup" class="fixed z-[200] bg-white dark:bg-gray-800 shadow-xl p-4 hidden overflow-y-auto" style="max-width: 600px; max-height: 80vh;">
            <button id="wikipedia-popup-close" onclick="document.getElementById('wikipedia-popup').style.display='none'" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="wikipedia-popup-layout" class="flex flex-col h-full">
                <img id="wikipedia-popup-image" class="w-full object-contain mb-4 rounded" style="max-height: 200px; max-width: 100%; height: auto; display: none;" alt="Article image" />
                <div class="flex-1">
                    <div id="wikipedia-popup-content"></div>
                </div>
            </div>
        </div>
        <!-- Splash Screen -->
        <div x-show="initialLoading" x-transition class="fixed inset-0 flex items-center justify-center bg-white dark:bg-dark-bg z-50">
            <div class="text-center">
                <img :src="$store.theme.current === 'dark' ? '{{ static_path }}/svg/kite_dark.svg' : '{{ static_path }}/svg/kite.svg'" alt="Kite Logo" class="w-24 h-24 mx-auto mb-4 animate-bounce" />
                <h1 class="text-2xl font-bold text-gray-800 dark:text-dark-text mb-2 flex items-center">
                    Kite
                    <span class="bg-yellow-200 font-medium mt-0.5 ml-2 rounded-lg px-2 py-0.5 text-xs text-black">BETA</span>
                </h1>
                <p class="text-xl text-gray-600 dark:text-gray-400">News. Elevated.</p>
                <p x-text="loadingProgress > 20 ? loadingProgress + '%' : ''" class="mt-4 text-sm text-gray-500 dark:text-gray-400 min-h-[1.5rem]"></p>
            </div>
        </div>

        <!-- About Screen -->
        <div x-show="showIntro && !getArticleIdFromUrl()" x-cloak class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50 overflow-y-auto">
            <div class="w-full h-full max-w-3xl mx-auto p-4 sm:p-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-8">
                    <div class="flex justify-between items-start mb-8">
                        <div class="w-full">
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Kite</h1>
                            <p class="text-gray-600 dark:text-gray-300">News app by Kagi</p>
                        </div>
                    </div>

                    <div class="space-y-6 text-gray-700 dark:text-gray-300">
                        <section>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Why Kite? Because news is broken.</h2>
                            <p class="mb-4">
                                Driven by relentless ad monetization, news has <a class="text-blue-600 dark:text-blue-400 hover:underline" href="https://gwern.net/doc/culture/2010-dobelli.pdf">become</a> mental junk food - an endless stream of clickbait that destroys our ability to think deeply and clearly. We can do better, and create what news should have been all along - pure, essential information that respects your intelligence and time.
                            </p>
                        </section>
                        <section>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Understanding our approach</h2>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">World doesn't live in echo chambers. The reality emerges from the collision of different viewpoints and perspectives - that's how we separate signal from noise.</p>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">We strive for diversity and transparency of resources and welcome your <a class="text-blue-600 dark:text-blue-400 hover:underline" href="https://github.com/kagisearch/kite-public">contributions</a> to widen perspectives. This multi-source approach helps reveal the full picture beyond any single viewpoint.</p>
                            <p class="mb-4 text-gray-700 dark:text-gray-300">Kite reads thousands of community-curated global publications and distills them into one perfect daily briefing. You get every critical perspective and timeline in just 5 minutes. That's it. No endless scrolling. No attention hijacking. Because we deserve better.</p>
                        </section>

                        <section>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Core principles</h2>
                            <ul class="space-y-2">
                                <li> One daily update (noon UTC), creating a natural endpoint to your news consumption</li>
                                <li> Focus on facts and perspectives over opinions</li>
                                <li> Zero compromise on privacy - your reading habits are yours alone</li>
                                <li> Quality and depth over quantity</li>
                                <li> Complete news diet in 5 minutes</li>
                                <li> Liberation from the attention economy - exist in the moment, not in an endless scroll</li>
                            </ul>
                        </section>
                        <section>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Customization</h2>
                            <p>
                                Personalize your feed by reordering and toggling categories in settings. Want to contribute? Most of Kite is <a class="text-blue-600 dark:text-blue-400 hover:underline" href="https://github.com/kagisearch/kite-public">open source</a>, including our web app and community-curated feeds.
                            </p>
                        </section>
                        <section>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Contact</h2>
                            <p>
                                For feedback, please use <a class="text-blue-600 dark:text-blue-400 hover:underline" href="https://kagifeedback.org">Kagi Feedback</a>. For support,
                                <a href="mailto:support@kagi.com" class="text-blue-600 dark:text-blue-400 hover:underline">support@kagi.com</a>.
                            </p>
                        </section>

                        <div class="mt-8 flex justify-center">
                            <button
                                @click="closeIntro()"
                                class="px-6 py-3 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-colors duration-200 ease-in-out"
                            >
                                I understand
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main x-show="!initialLoading && !showIntro" x-cloak class="pb-[60px] md:pb-0">
            <div class="container mx-auto px-4 py-8 max-w-[732px]">
                <header class="flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <img
                            :src="$store.theme.current === 'dark' || ($store.theme.current === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) ? '{{ static_path }}/svg/kite_dark.svg' : '{{ static_path }}/svg/kite.svg'"
                            alt="Kite News Logo"
                            class="w-8 h-8 mr-2"
                            @click="$event.target.classList.add('kite-logo'); setTimeout(() => $event.target.classList.remove('kite-logo'), 3000)"
                        />
                        <a href="javascript:void(0)" @click="window.location.href = window.location.pathname" class="flex items-center">
                            <h1 class="text-xl font-bold text-gray-800 dark:text-gray-200">Kite</h1>
                        </a>
                    </div>
                    <div
                        class="text-gray-600 dark:text-gray-400 cursor-pointer"
                        x-data="{ dateClickCount: 0 }"
                        @click="dateClickCount = (dateClickCount + 1) % 5"
                        x-text="dateClickCount === 0 ? new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).format(new Date())                                                                                                                                                                        
                             : dateClickCount === 1 ? getLastUpdated()                                                                                                                                                                                                                                                                                           
                             : dateClickCount === 2 ? `${totalReadCount} news today`
                             : dateClickCount === 3 ? `You've read ${totalStoriesRead} stories`
                             : `Week ${Math.ceil((new Date() - new Date(new Date().getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24 * 7))}, Day ${Math.ceil((new Date() - new Date(new Date().getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24))}`"
                    ></div>
                    <div class="flex items-center space-x-2">
                        </button>
                        <button @click="$store.settings.open()" title="Settings" class="ml-2">
                            <img src="{{ static_path }}/svg/gear.svg" alt="" class="h-6 w-6 text-gray-600 dark:text-gray-400 dark:invert" aria-hidden="true" />
                        </button>
                    </div>
                </header>
                <div class="category-slider-container px-6 md:px-0 md:sticky md:top-0 fixed md:relative bg-white dark:bg-dark-bg pb-12 md:py-2 z-[60] shadow-[0_-4px_8px_rgba(0,0,0,0.1)] md:shadow-none" 
                    :class="{ 
                        'bottom-0 left-0 right-0': $store.mobileUI.categoryHeaderPosition === 'bottom',
                        'top-0 left-0 right-0': $store.mobileUI.categoryHeaderPosition === 'top'
                    }"
                    @touchstart="isScrolling = false" 
                    @touchmove="isScrolling = true"
                    @touchend="setTimeout(() => isScrolling = false, 50)"
                    role="navigation"
                    x-data="{ 
                        hasOverflow: false,
                        checkOverflow() {
                            const tabs = document.querySelector('.category-tabs');
                            if (tabs) {
                                const newValue = tabs.scrollWidth > tabs.clientWidth;
                                if (newValue !== this.hasOverflow) {
                                    this.hasOverflow = newValue;
                                }
                            }
                        }
                    }"
                    x-init="
                        $nextTick(() => {
                            checkOverflow();
                            // Set up mutation observer to watch for changes in category-tabs
                            const observer = new MutationObserver((mutations) => {
                                $nextTick(() => {
                                    checkOverflow();
                                    // Double check after a small delay
                                    setTimeout(() => {
                                        checkOverflow();
                                        $nextTick(() => checkOverflow());
                                    }, 100);
                                });
                            });
                            
                            const tabs = document.querySelector('.category-tabs');
                            if (tabs) {
                                observer.observe(tabs, {
                                    childList: true,
                                    subtree: true,
                                    attributes: true
                                });
                            }
                        });
                        window.addEventListener('resize', () => {
                            checkOverflow();
                            $nextTick(() => checkOverflow());
                        });
                    "
                >
                    <div class="relative flex items-center">
                        <div class="relative flex items-center w-full">
                            <button 
                                @click="document.querySelector('.category-tabs').scrollBy({left: -200, behavior: 'smooth'})"
                                class="relative focus:outline-none md:block hidden -ml-1 pr-4 py-3
                                text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors"
                                :class="{ 'md:hidden': !hasOverflow }"
                                x-cloak
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div class="category-tabs overflow-x-auto scrollbar-hide flex-1" 
                                role="tablist" 
                                aria-label="News categories" 
                                @touchstart="isScrolling = false" 
                                @touchmove="isScrolling = true"
                                @touchend="setTimeout(() => isScrolling = false, 50)"
                                @scroll="checkOverflow()"
                            >
                                <template x-for="category in availableCategories.filter(cat => $store.categories.isEnabled(cat.name))" :key="category.name">
                                    <div
                                        role="tab"
                                        :aria-selected="currentCategory === category.name"
                                        :aria-controls="'category-' + category.name"
                                        class="category-tab whitespace-nowrap"
                                        :class="{ 'active': currentCategory === category.name }"
                                        @click="if (!isScrolling) { 
                                            currentCategory = category.name; 
                                            changeCategory(); 
                                            updateUrlWithArticleId('');
                                            
                                            
                                            // Scroll the category into view
                                            $el.scrollIntoView({ 
                                                behavior: 'smooth', 
                                                block: 'nearest',
                                                inline: 'center'
                                            });
                                        }"
                                        x-text="category.name === 'OnThisDay' ? 'Today in History' : category.name"
                                    ></div>
                                </template>
                            </div>
                            <button 
                                @click="document.querySelector('.category-tabs').scrollBy({left: 200, behavior: 'smooth'})"
                                class="relative focus:outline-none md:block hidden -mr-1 pl-4 py-3
                                text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors"
                                :class="{ 'md:hidden': !hasOverflow }"
                                x-cloak
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div x-show="currentCategory === 'World' && $store.chaosIndex.score > 0" class="mb-4 flex justify-between items-center">
                    <div x-data="{ showChaosPopup: false }" class="relative">
                        <div
                            @click="setTimeout(() => showChaosPopup = true, 100)"
                            class="px-3 py-1.5 flex items-center justify-center cursor-pointer rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200"
                            title="Turbulence meter"
                        >
                            <span x-text="$store.chaosIndex.score" class="text-sm font-medium"></span>
                        </div>
                        <div
                            x-show="showChaosPopup"
                            x-transition:enter="transition ease-out duration-300"
                            x-transition:enter-start="opacity-0 transform scale-90"
                            x-transition:enter-end="opacity-100 transform scale-100"
                            x-transition:leave="transition ease-in duration-300"
                            x-transition:leave-start="opacity-100 transform scale-100"
                            x-transition:leave-end="opacity-0 transform scale-90"
                            @click.away="showChaosPopup = false"
                            @keydown.escape.window="showChaosPopup = false"
                            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50"
                        >
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative">
                                <button @click="showChaosPopup = false" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">World turbulence meter</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-8" x-text="getLastUpdated()"></p>
                                <!-- Updated Progress Bar with Segments and Notches -->
                                <div class="relative mb-4">
                                    <!-- Chaos Index Score Display -->
                                    <div class="absolute -top-6 left-0 right-0">
                                        <span x-text="$store.chaosIndex.score" :style="{ left: $store.chaosIndex.score + '%', transform: 'translateX(-50%)' }" style="position: absolute;">50</span>
                                    </div>
                                    <div class="relative w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 overflow-hidden">
                                        <!-- Segmented Background -->
                                        <div class="absolute top-0 left-0 h-4 w-full rounded-full overflow-hidden flex">
                                            <div class="h-4 w-1/5" style="background-color: #4caf50;"></div>
                                            <!-- 0-20 -->
                                            <div class="h-4 w-1/5" style="background-color: #8bc34a;"></div>
                                            <!-- 21-40 -->
                                            <div class="h-4 w-1/5" style="background-color: #ffeb3b;"></div>
                                            <!-- 41-60 -->
                                            <div class="h-4 w-1/5" style="background-color: #ff9800;"></div>
                                            <!-- 61-80 -->
                                            <div class="h-4 w-1/5" style="background-color: #f44336;"></div>
                                            <!-- 81-100 -->
                                        </div>

                                        <!-- Notches -->
                                        <div class="absolute top-0 left-[20%] w-0.5 h-4 bg-white"></div>
                                        <div class="absolute top-0 left-[40%] w-0.5 h-4 bg-white"></div>
                                        <div class="absolute top-0 left-[60%] w-0.5 h-4 bg-white"></div>
                                        <div class="absolute top-0 left-[80%] w-0.5 h-4 bg-white"></div>

                                        <!-- Score Notch -->
                                        <div class="absolute top-0 w-1 h-4 bg-gray-500" :style="{ left: $store.chaosIndex.score + '%' }" :aria-valuenow="$store.chaosIndex.score" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <!-- Labels -->
                                    <div class="absolute -bottom-5 left-0 text-xs text-gray-700 dark:text-gray-300">0</div>
                                    <div class="absolute -bottom-5 left-[20%] transform -translate-x-1/2 text-xs text-gray-700 dark:text-gray-300">20</div>
                                    <div class="absolute -bottom-5 left-[40%] transform -translate-x-1/2 text-xs text-gray-700 dark:text-gray-300">40</div>
                                    <div class="absolute -bottom-5 left-[60%] transform -translate-x-1/2 text-xs text-gray-700 dark:text-gray-300">60</div>
                                    <div class="absolute -bottom-5 left-[80%] transform -translate-x-1/2 text-xs text-gray-700 dark:text-gray-300">80</div>
                                    <div class="absolute -bottom-5 right-0 text-xs text-gray-700 dark:text-gray-300">100</div>
                                </div>

                                <!-- Current Bucket Description -->
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-8">
                                    <span class="font-semibold text-gray-800 dark:text-gray-200">
                                        <span x-text="$store.chaosIndex.getBucketDescription().split(':')[0] + ':'"></span>
                                    </span>
                                    <span x-text="$store.chaosIndex.getBucketDescription().split(':')[1].trim()"></span>
                                </p>

                                <!-- Chaos Summary -->
                                <p class="text-gray-600 dark:text-gray-400 mt-4" x-html="$store.chaosIndex.summary.replace(/\n/g, '<br>')"></p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button @click="viewMode = 'list'" :class="{'text-blue-500': viewMode === 'list', 'text-gray-500': viewMode !== 'list'}" aria-label="Switch to list view" title="List view">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                            </svg>
                        </button>
                        <button @click="viewMode = 'map'" :class="{'text-blue-500': viewMode === 'map', 'text-gray-500': viewMode !== 'map'}" aria-label="Switch to map view" title="Map view">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                                />
                            </svg>
                        </button>
                    </div>
                </div>
                <div>
                    <template x-if="viewMode === 'map' && currentCategory === 'World'">
                        <div class="py-4">
                            <iframe :src="'kite_map.html?timestamp=' + Date.now()" class="w-full h-[calc(100vh-200px)] border-none"></iframe>
                        </div>
                    </template>
                    <template x-if="viewMode === 'list' && currentCategory === 'OnThisDay'">
                        <div class="py-4" x-data="{ hoveredLink: null, popupContent: null, popupVisible: false, popupPosition: { x: 0, y: 0 } }">
                           <!-- Events Section -->
                            <div class="mb-8">
                                <h3 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-300">Events</h3>
                                
                                <template 
                                x-for="(event, index) in stories.filter(e => !e.content.toLowerCase().includes('was born') && !e.content.toLowerCase().includes('died'))" 
                                :key="index"
                                >
                                <div 
                                    class="
                                    relative pb-6 last:pb-0
                                    flex flex-col
                                    
                                    /* Switch to 2-column grid on md+, left-align items */
                                    md:grid md:grid-cols-[auto_1fr] md:gap-4 
                                    md:justify-items-start md:items-start
                                    
                                    /* Vertical line connecting dots */
                                    before:content-[''] before:absolute 
                                    before:top-[14px] before:bottom-[-16px]
                                    before:left-[3px] before:w-[2px] before:bg-[var(--color-header)]
                                    last:before:content-none
                                    "
                                >
                                    <!-- Dot + Year -->
                                    <div class="flex items-center">
                                    <!-- Dot -->
                                    <span 
                                        class="relative z-10 w-2 h-2 bg-[var(--color-header)] rounded-full"
                                    ></span>
                                    
                                    <!-- Year -->
                                    <span 
                                        class="ml-2 text-2xl pl-2 font-bold text-[var(--color-header)]"
                                        x-text="event.year"
                                    ></span>
                                    </div>
                            
                                    <!-- Text -->
                                    <!-- On mobile, it's below the dot+year; on md+ it's in the second column -->
                                    <div class="mt-2 md:mt-0 pl-6 md:pl-0">
                                    <span
                                        class="text-sm text-gray-700 dark:text-gray-300"
                                        x-html="event.content.replace(/href=/g, 'class=\'underline\' href=')"
                                    ></span>
                                    </div>
                                </div>
                                </template>
                            </div>
                            
                            <!-- People Section Carousel -->
                            <div x-data="peopleCarousel(stories)">
                                <h3 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-300">People</h3>
                                
                                <!-- ============ DESKTOP CAROUSEL (md and up) ============ -->
                                <div class="relative hidden md:block">
                                <!-- Left Arrow -->
                                <button 
                                    class="absolute left-[-2rem] top-1/2 -translate-y-1/2 px-2 py-1
                                        rounded cursor-pointer disabled:opacity-50
                                        text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors"
                                    @click="prevSlide" 
                                    :disabled="currentSlide === 0"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M15 19l-7-7 7-7" />
                                    </svg>
                                </button>
                            
                                <!-- Slides Wrapper (overflow hidden) -->
                                <div class="overflow-hidden" @wheel="onWheel($event)">
                                    <!-- Inner track that slides back & forth -->
                                    <div 
                                    class="flex transition-transform duration-300 ease-out"
                                    :style="`transform: translateX(-${currentSlide * 100}%)`"
                                    >
                                    <!-- Each "slide" is a group of up to 3 stories -->
                                    <template x-for="(slide, sIndex) in chunkedStories" :key="sIndex">
                                        <div class="flex w-full shrink-0 justify-around">
                                        
                                        <!-- Each story card within the slide -->
                                        <template x-for="(event, index) in slide" :key="index">
                                            <div class="relative flex flex-col items-center text-center px-4 w-1/3">
                                            
                                            <!-- Vertical separator between cards (except last card in the slide) -->
                                            <div 
                                                x-show="index < slide.length - 1" 
                                                class="absolute right-0 top-0 h-full w-[1px] bg-[var(--color-header)]"
                                            ></div>
                                            
                                            <!-- YEAR -->
                                            <span 
                                                class="text-2xl font-bold mb-2 mr-auto text-[var(--color-header)]" 
                                                x-text="event.year"
                                            ></span>
                            
                                            <!-- IMAGE + TEXT -->
                                            <div class="flex items-start gap-4">                     
                                                <!-- IMAGE -->
                                                <img 
                                                class="w-10 h-10 object-cover rounded-full flex-shrink-0" 
                                                :src="event.image || '{{ static_path }}/svg/placeholder.svg'" 
                                                alt="placeholder"
                                                />
                                                
                                                <!-- TEXT -->
                                                <span 
                                                class="text-sm text-gray-700 dark:text-gray-300 text-left"
                                                x-html="event.content.replace(/href=/g, 'class=\'underline\' href=')"
                                                ></span>
                                            </div>
                                            </div>
                                        </template>
                                        </div>
                                    </template>
                                    </div>
                                </div>
                            
                                <!-- Right Arrow -->
                                <button 
                                    class="absolute right-[-2rem] top-1/2 -translate-y-1/2 px-2 py-1
                                        rounded cursor-pointer disabled:opacity-50
                                        text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors"
                                    @click="nextSlide"
                                    :disabled="currentSlide >= chunkedStories.length - 1"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                                
                                <!-- Pagination Dots (Desktop) -->
                                <div class="flex justify-center space-x-2 mt-8">
                                    <template x-for="(slide, i) in chunkedStories" :key="i">
                                    <span 
                                        class="block w-2 h-2 rounded-full cursor-pointer transition-colors"
                                        :class="currentSlide === i 
                                                ? 'bg-[var(--color-header)]' 
                                                : 'bg-gray-300 dark:bg-gray-600'"
                                        @click="goToSlide(i)"
                                    ></span>
                                    </template>
                                </div>
                                </div>
                            
                                <!-- ============ MOBILE HORIZONTAL SCROLL (below md) ============ -->
                                <div class="md:hidden overflow-x-auto flex space-x-4 horizontal-scroll-container"
                                    @touchstart="isScrolling = true" 
                                    @touchend="setTimeout(() => isScrolling = false, 50)"
                                >
                                <!-- Show *all* filtered stories in one row; user can scroll -->
                                <template x-for="(event, index) in peopleStories" :key="index">
                                    <div class="relative flex flex-col items-center text-center min-w-[200px] px-2">
                                    
                                    <!-- Vertical line between items (except the last one) -->
                                    <div 
                                        x-show="index < peopleStories.length - 1" 
                                        class="absolute right-0 top-0 h-full w-[1px] bg-[var(--color-header)]"
                                    ></div>
                                    
                                    <!-- YEAR -->
                                    <span 
                                        class="text-lg font-bold mb-2 text-[var(--color-header)]"
                                        x-text="event.year"
                                    ></span>
                                    
                                    <!-- IMAGE -->
                                    <img 
                                        class="mb-2 w-20 h-20 object-cover rounded-full" 
                                        :src="event.image || '{{ static_path }}/svg/placeholder.svg'" 
                                        alt="placeholder"
                                    />
                                    
                                    <!-- TEXT -->
                                    <span 
                                        class="text-gray-700 dark:text-gray-300"
                                        x-html="event.content.replace(/href=/g, 'class=\'underline\' href=')"
                                    ></span>
                                    </div>
                                </template>
                                </div>
                            </div>

                            <!-- Wikipedia Popup -->
                            <div
                                x-show="popupVisible"
                                x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 translate-y-4"
                                x-transition:enter-end="opacity-100 translate-y-0"
                                x-transition:leave="transition ease-in duration-150"
                                x-transition:leave-start="opacity-100 translate-y-0"
                                x-transition:leave-end="opacity-0 translate-y-4"
                                class="fixed inset-0 z-50 bg-white dark:bg-gray-800 md:rounded-lg md:shadow-xl md:max-w-sm md:w-[90vw] md:max-h-[80vh] md:overflow-hidden flex flex-col"
                                :class="{
                                    'md:absolute': window.innerWidth > 768,
                                    'md:left-[${popupPosition.x}px] md:top-[${popupPosition.y}px]': window.innerWidth > 768
                                }"
                            >
                                <!-- Mobile Header -->
                                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 md:hidden">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200" x-text="popupContent?.title"></h3>
                                    <button 
                                        @click="popupVisible = false"
                                        class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                    >
                                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Image Section -->
                                <div x-show="popupContent?.thumbnail" class="relative h-48 w-full">
                                    <img 
                                        :src="popupContent?.thumbnail?.source" 
                                        :alt="popupContent?.title" 
                                        class="w-full h-full object-cover"
                                        loading="lazy"
                                    />
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
                                    <h3 class="absolute bottom-4 left-4 text-xl font-bold text-white hidden md:block" x-text="popupContent?.title"></h3>
                                </div>

                                <!-- Content Section -->
                                <div class="flex-1 p-4 md:p-6 overflow-y-auto">
                                    <!-- Description -->
                                    <p x-show="popupContent?.description" 
                                       class="text-sm text-gray-600 dark:text-gray-300 mb-4 leading-relaxed"
                                       x-text="popupContent?.description"></p>

                                    <!-- Main Content -->
                                    <div class="prose prose-sm dark:prose-invert max-w-none">
                                        <p x-html="popupContent?.extract_html"></p>
                                    </div>

                                    <!-- Read More Link -->
                                    <div class="mt-4">
                                        <a 
                                            :href="'https://en.wikipedia.org/wiki/' + encodeURIComponent(popupContent?.title)"
                                            target="_blank"
                                            class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:underline"
                                        >
                                            <span>Read more on Wikipedia</span>
                                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                        </a>
                                    </div>
                                </div>

                                <!-- Close Button (Desktop) -->
                                <button 
                                    @click="popupVisible = false"
                                    class="absolute top-2 right-2 p-2 rounded-full bg-white/80 dark:bg-gray-700/80 backdrop-blur-sm hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors hidden md:block"
                                >
                                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>

                                <!-- Mobile Footer -->
                                <div class="p-4 border-t border-gray-200 dark:border-gray-700 md:hidden">
                                    <button 
                                        @click="popupVisible = false"
                                        class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                    <template x-if="currentCategory !== 'OnThisDay'">
                        <template x-for="(story, index) in stories" :key="story.category + story.cluster_number">
                            <article
                                :id="'story-' + index"
                                role="article"
                                :aria-expanded="story.expanded"
                                :aria-label="'News story: ' + story.title"
                                class="py-2 relative"
                                :class="{'border-b border-gray-200 dark:border-gray-700': !story.expanded}"
                            >
                                <header class="flex justify-between items-center mb-1">
                                    <span class="category-label text-gray-700 dark:text-gray-300 text-sm py-1 rounded inline-flex items-center">
                                        <span :class="'topic-color-' + ((story.category.charCodeAt(0) + story.category.charCodeAt(1) + story.category.length) % 9 + 1)" x-text="story.category"></span>
                                        
                                    </span>
                                </header>
                                <div class="flex items-start">
                                    <div class="flex-grow">
                                        <h2
                                            class="text-xl text-gray-800 dark:text-dark-text mb-2 cursor-pointer"
                                            :class="readStories[story.title] ? '' : 'font-semibold'"
                                            x-text="story.title"
                                            @click="toggleStory(story, index)"
                                            :id="'story-title-' + index"
                                        ></h2>
                                    </div>
                                    <div class="flex-shrink-0 ml-4 -mt-3">
                                        <button @click.stop="readStories[story.title] = !readStories[story.title]; localStorage.setItem('readStories', JSON.stringify(readStories))" class="focus:outline-none">
                                            <svg
                                                :class="readStories[story.title] ? 'text-gray-600 dark:text-gray-400' : 'text-gray-300 dark:text-gray-600'"
                                                class="w-6 h-6"
                                                xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 19 19"
                                                :fill="readStories[story.title] ? '#7BA3FF' : 'currentColor'"
                                                :stroke="readStories[story.title] ? '#427AFC' : 'none'"
                                                title="Click to toggle read status"
                                            >
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <section x-show="story.expanded" class="py-4 bg-white dark:bg-dark-bg flex flex-col" @click.stop x-effect="$store.sections.order">
                                    <section x-show="$store.sections.settings.summary" :class="'order-' + $store.sections.order.indexOf('summary')" class="mt-6">
                                        <p x-show="$store.sections.settings.summary" class="mb-6" x-text="story.short_summary"></p>
                                        <p x-show="story.location" class="flex items-center text-gray-600 dark:text-gray-300 cursor-pointer" @click="openMaps(story.location)" title="Open location in maps">
                                            <img src="{{ static_path }}/svg/map.svg" alt="Map icon" class="w-5 h-5 mr-2" />
                                            <span x-text="story.location"></span>
                                        </p>
                                    </section>

                                    <section x-show="story.articles.some(a => a.image) && $store.sections.settings.primaryImage" :class="'order-[' + $store.sections.order.indexOf('primaryImage') + ']'" class="mt-6"> 
                                        <figure>
                                            <div class="relative">
                                                <template x-if="story.articles.find(a => a.image) && $store.sections.settings.primaryImage">
                                                    <div class="relative w-[calc(100%-1rem)] max-w-[800px] mx-auto">
                                                        <a :href="story.articles.find(a => a.image).link" target="_blank" class="relative block">
                                                            <img :src="story.articles.find(a => a.image).image" :alt="story.articles.find(a => a.image).image_caption || 'Story image'" class="w-full h-auto rounded-lg shadow-md" loading="lazy" />
                                                            <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-sm px-2 py-1 rounded hover:bg-opacity-75">
                                                                <span x-text="story.articles.find(a => a.image).domain"></span>
                                                            </div>
                                                        </a>
                                                        <template x-if="story.articles.find(a => a.image).image_caption">
                                                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400 italic" x-text="story.articles.find(a => a.image).image_caption"></p>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </figure>
                                    </section>

                                    <section x-show="$store.sections.settings.highlights" :class="'order-[' + $store.sections.order.indexOf('highlights') + ']'" class="mt-6">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Highlights</h3>
                                        <div class="border-t border-dashed border-gray-300 dark:border-gray-600">
                                            <template x-for="(point, index) in story.talking_points" :key="point">
                                                <div class="py-4 border-b border-dashed border-gray-300 dark:border-gray-600 relative pl-10">
                                                    <div class="absolute left-0 top-4">
                                                        <div class="w-6 h-6 rounded-full bg-[#F9D9B8] flex items-center justify-center">
                                                            <span class="text-gray-800 text-sm font-semibold" x-text="index + 1"></span>
                                                        </div>
                                                    </div>
                                                    <template x-if="point.includes(':')">
                                                        <div>
                                                            <div class="flex items-start">
                                                                <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2" x-text="point.split(':')[0].trim()"></h4>
                                                            </div>
                                                            <p class="text-gray-700 dark:text-gray-300 -ml-10" x-text="point.split(':')[1].trim()"></p>
                                                        </div>
                                                    </template>
                                                    <template x-if="!point.includes(':')">
                                                        <p class="text-gray-700 dark:text-gray-300" x-text="point"></p>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </section>

                                    <section x-show="story.quote && $store.sections.settings.quotes" class="my-8 bg-[#F3F6FE] dark:bg-gray-700 rounded-lg p-4" :class="'order-[' + $store.sections.order.indexOf('quotes') + ']'">
                                        <blockquote class="text-lg text-black dark:text-white">
                                            <span x-text="story.quote"></span>
                                        </blockquote>
                                        <p x-show="story.quote_author" class="text-left text-gray-700 dark:text-gray-300 mt-2">
                                            <template x-if="story.quote_source_url">
                                                <a :href="story.quote_source_url" target="_blank" rel="noopener noreferrer" class="text-[#183FDC] dark:text-[#5B89FF] hover:underline">
                                                    <span x-text="story.quote_author + (story.quote_source_domain ? ' (via ' + story.quote_source_domain + ')' : '')"></span>
                                                </a>
                                            </template>
                                            <template x-if="!story.quote_source_url">
                                                <span x-text="story.quote_author"></span>
                                            </template>
                                        </p>
                                    </section>

                                    <section x-show="story.articles.filter(a => a.image).length >= 2 && $store.sections.settings.secondaryImage" class="mt-6" :class="'order-[' + $store.sections.order.indexOf('secondaryImage') + ']'">
                                        <template x-if="story.articles.filter(a => a.image)[1] && $store.sections.settings.secondaryImage">
                                            <div class="relative w-[calc(100%-1rem)] max-w-[800px] mx-auto">
                                                <a :href="story.articles.filter(a => a.image)[1].link" target="_blank" class="relative block">
                                                    <img
                                                        :src="story.expanded ? story.articles.filter(a => a.image)[1].image : ''"
                                                        :alt="story.articles.filter(a => a.image)[1].image_caption || 'Additional story image'"
                                                        loading="lazy"
                                                        class="w-full h-auto rounded-lg shadow-md"
                                                    />
                                                    <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-sm px-2 py-1 rounded hover:bg-opacity-75">
                                                        <span x-text="story.articles.filter(a => a.image)[1].domain"></span>
                                                    </div>
                                                </a>
                                                <template x-if="story.articles.filter(a => a.image)[1].image_caption">
                                                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400 italic" x-text="story.articles.filter(a => a.image)[1].image_caption"></p>
                                                </template>
                                            </div>
                                        </template>
                                    </section>

                                    <section x-show="story.perspectives && story.perspectives.length > 0 && $store.sections.settings.perspectives" class="mt-6" :class="'order-[' + $store.sections.order.indexOf('perspectives') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Perspectives</h3>
                                        <div class="flex flex-row overflow-x-auto gap-3 pb-4 horizontal-scroll-container"
                                            @touchstart="isScrolling = true" 
                                            @touchend="setTimeout(() => isScrolling = false, 50)"
                                        >
                                            <template x-for="(perspective, index) in story.perspectives" :key="index">
                                                <div class="flex-shrink-0 w-56 bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                                    <p class="text-gray-800 dark:text-gray-200 font-bold mb-2" x-text="perspective.text.includes(':') ? perspective.text.split(':')[0] : ''"></p>
                                                    <p class="text-gray-700 dark:text-gray-300 mb-2" x-text="perspective.text.includes(':') ? perspective.text.split(':').slice(1).join(':').trim() : perspective.text"></p>
                                                    <template x-if="perspective.sources && perspective.sources.length > 0">
                                                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                                            <template x-for="(source, index) in perspective.sources" :key="index">
                                                                <span>
                                                                    <a :href="source.url" target="_blank" rel="noopener noreferrer" class="text-[#183FDC] dark:text-[#5B89FF] hover:underline" x-text="source.name"></a>
                                                                    <template x-if="index < perspective.sources.length - 1">
                                                                        <span>  </span>
                                                                    </template>
                                                                </span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </section>

                                    <section x-show="story.historical_background && $store.sections.settings.historicalBackground" :class="'order-[' + $store.sections.order.indexOf('historicalBackground') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Historical background</h3>
                                        <p class="mb-4 text-gray-700 dark:text-gray-300" x-text="story.historical_background"></p>
                                    </section>

                                    <section x-show="story.humanitarian_impact && $store.sections.settings.humanitarianImpact" :class="'order-[' + $store.sections.order.indexOf('humanitarianImpact') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                            Humanitarian impact
                                        </h3>
                                        <p class="mb-4 text-gray-700 dark:text-gray-300" x-text="story.humanitarian_impact" :class="'order-[' + $store.sections.order.indexOf('humanitarianImpact') + ']'"></p>
                                    </section>

                                    <section x-show="story.technical_details && story.technical_details.length > 0 && $store.sections.settings.technicalDetails" :class="'order-[' + $store.sections.order.indexOf('technicalDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Technical details</h3>
                                        <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2">
                                            <template x-for="detail in story.technical_details" :key="detail">
                                                <li x-text="detail"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="(story.business_angle_text || (story.business_angle_points && story.business_angle_points.length > 0)) && $store.sections.settings.businessAngle" :class="'order-[' + $store.sections.order.indexOf('businessAngle') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Business angle</h3>
                                        <p x-show="story.business_angle_text" class="mb-4 text-gray-700 dark:text-gray-300" x-text="story.business_angle_text"></p>
                                        <ul x-show="story.business_angle_points && story.business_angle_points.length > 0" class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2">
                                            <template x-for="point in story.business_angle_points" :key="point">
                                                <li x-text="point"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="story.international_reactions && story.international_reactions.length > 0 && $store.sections.settings.internationalReactions" :class="'order-[' + $store.sections.order.indexOf('internationalReactions') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">
                                            International reactions
                                        </h3>
                                        <div class="space-y-2">
                                            <template x-for="reaction in story.international_reactions" :key="reaction">
                                                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                                    <template x-if="typeof reaction === 'string' && reaction.includes(':')">
                                                        <div>
                                                            <h4 class="font-semibold text-gray-800 dark:text-gray-200" x-text="reaction.split(':')[0].trim()"></h4>
                                                            <p class="text-gray-700 dark:text-gray-300" x-text="reaction.split(':')[1].trim().endsWith('.') ? reaction.split(':')[1].trim() : reaction.split(':')[1].trim() + '.'"></p>
                                                        </div>
                                                    </template>
                                                    <template x-if="typeof reaction === 'string' && !reaction.includes(':')">
                                                        <p class="text-gray-700 dark:text-gray-300" x-text="reaction.endsWith('.') ? reaction : reaction + '.'"></p>
                                                    </template>
                                                    <template x-if="typeof reaction !== 'string'">
                                                        <p class="text-gray-700 dark:text-gray-300">Invalid reaction format</p>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </section>

                                    <section x-show="story.scientific_significance && story.scientific_significance.length > 0 && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Scientific significance</h3>
                                        <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2">
                                            <template x-for="point in story.scientific_significance" :key="point">
                                                <li x-text="point"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="story.travel_advisory && story.travel_advisory.length > 0 && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Travel advisory</h3>
                                        <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2">
                                            <template x-for="point in story.travel_advisory" :key="point">
                                                <li x-text="point"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="story.performance_statistics && story.performance_statistics.length > 0 && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Performance statistics</h3>
                                        <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300 space-y-2">
                                            <template x-for="stat in story.performance_statistics" :key="stat">
                                                <li x-text="stat"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="story.league_standings && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">League standings</h3>
                                        <p class="mb-4 text-gray-700 dark:text-gray-300" x-text="story.league_standings"></p>
                                    </section>

                                    <section x-show="story.design_principles && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Design principles</h3>
                                        <p class="mb-4 text-gray-700 dark:text-gray-300" x-text="story.design_principles"></p>
                                    </section>

                                    <section x-show="story.user_experience_impact && story.user_experience_impact.length > 0 && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">User experience impact</h3>
                                        <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300">
                                            <template x-for="impact in story.user_experience_impact" :key="impact">
                                                <li x-text="impact"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="story.gameplay_mechanics && story.gameplay_mechanics.length > 0 && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Gameplay mechanics</h3>
                                        <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300">
                                            <template x-for="mechanic in story.gameplay_mechanics" :key="mechanic">
                                                <li x-text="mechanic"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="story.gaming_industry_impact && story.gaming_industry_impact.length > 0 && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Industry impact</h3>
                                        <ul class="list-disc list-inside mb-4 text-gray-700 dark:text-gray-300">
                                            <template x-for="impact in story.gaming_industry_impact" :key="impact">
                                                <li x-text="impact"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="story.technical_specifications && $store.sections.settings.otherDetails" :class="'order-[' + $store.sections.order.indexOf('otherDetails') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-6 mb-2">Technical specifications</h3>
                                        <p class="mb-4 text-gray-700 dark:text-gray-300" x-text="story.technical_specifications"></p>
                                    </section>

                                    <section x-show="story.timeline && story.timeline.length > 0 && $store.sections.settings.timeline" :class="'order-[' + $store.sections.order.indexOf('timeline') + ']'">
                                        <h2 class="timeline-title text-xl font-semibold mt-6 mb-4">Timeline of events</h2>
                                        <div class="timeline">
                                            <template x-for="(event, index) in story.timeline" :key="index">
                                                <div class="row">
                                                    <div class="head">
                                                        <span class="step"></span>
                                                        <span
                                                            class="item-title"
                                                            x-text="typeof event === 'object' ? event.date : 
                                                        (typeof event === 'string' && event.includes('::')) ? event.split('::')[0] : ''"
                                                        ></span>
                                                    </div>
                                                    <div class="body">
                                                        <span
                                                            x-text="typeof event === 'object' ? event.description :
                                                        (typeof event === 'string' && event.includes('::')) ? event.split('::').slice(1).join(':') : event"
                                                        ></span>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </section>

                                    <section x-data="{ showAllSources: false, visibleSources: window.innerWidth <= 768 ? 4 : 8 }" 
                                            x-init="window.addEventListener('resize', () => { visibleSources = window.innerWidth <= 768 ? 4 : 8 })" x-show="$store.sections.settings.sources" :class="'order-[' + $store.sections.order.indexOf('sources') + ']'">
                                        <div class="flex items-center justify-between mt-6 mb-4">
                                            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Sources</h3>
                                            <button
                                                x-show="story.domains && story.domains.length > visibleSources"
                                                @click="showAllSources = !showAllSources"
                                                class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 focus:outline-none"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-5 w-5 inline-block ml-1 transform transition-transform duration-200"
                                                    :class="{'rotate-180': showAllSources}"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
                                            <template x-if="story.domains">
                                                <template x-for="(domain, index) in story.domains" :key="index">
                                                    <button
                                                        x-show="index < visibleSources || showAllSources"
                                                        class="flex flex-col items-start space-y-1 w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700 py-2 pl-2 rounded-lg transition-colors"
                                                        @click.stop="$dispatch('open-source', { domain: domain, story: story })"
                                                        :aria-label="'Show articles from ' + (domain?.name || 'Unknown')"
                                                        :title="'Show articles from ' + (domain?.name || 'Unknown')"
                                                        tabindex="-1"
                                                        style="outline: none;"
                                                    >
                                                        <div class="flex items-center space-x-2 w-full min-w-0">
                                                            <img
                                                                :src="domain?.favicon || '{{ static_path }}/svg/placeholder.svg'"
                                                                :alt="domain?.name ? domain.name + ' Favicon' : 'Default Favicon'"
                                                                class="w-5 h-5 rounded-full"
                                                                loading="lazy"
                                                            />
                                                            <span class="text-sm font-semibold truncate" x-text="domain?.name || 'Unknown'"></span>
                                                        </div>
                                                        <span class="text-xs text-gray-500 dark:text-gray-400 ml-7" x-text="story?.articles ? (story.articles.filter(a => a.domain === domain?.name).length + ' articles') : '0 articles'">
                                                        </span>
                                                    </button>
                                                </template>
                                            </template>
                                        </div>
                                    </section>

                                    <section x-show="story.user_action_items && story.user_action_items.length > 0 && $store.sections.settings.actionItems" class="bg-[#F1FAE8] dark:bg-[#2B411C] rounded-lg p-4 mt-6" :class="'order-[' + $store.sections.order.indexOf('actionItems') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">Action items</h3>
                                        <ul class="list-disc ml-4 mb-2 text-gray-700 dark:text-gray-200 space-y-2">
                                            <template x-for="item in story.user_action_items" :key="item">
                                                <li x-text="item"></li>
                                            </template>
                                        </ul>
                                    </section>

                                    <section x-show="story.did_you_know && $store.sections.settings.didYouKnow" class="bg-[#CED8FB] dark:bg-[#2A3B5E] rounded-lg p-4 mt-6" :class="'order-[' + $store.sections.order.indexOf('didYouKnow') + ']'">
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">Did you know?</h3>
                                        <p class="text-gray-700 dark:text-gray-200" x-text="story.did_you_know"></p>
                                    </section>

                                    <div class="flex justify-center items-center space-x-4 mt-6 w-full md:px-0 order-last">
                                        
<!--
                                        <button
                                            @click.stop="shareArticle(story)"
                                            :data-share-url="window.location.origin + window.location.pathname + '?article=' + currentCategory.toLowerCase() + '-' + story.cluster_number"
                                            class="w-full md:w-auto px-6 py-3 bg-white text-black border border-black font-semibold rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-colors duration-200 ease-in-out"
                                        >
                                            Share this
                                        </button>
                                        -->
                                        <button
                                            @click.stop="closeStory(story, index)"
                                            class="w-full md:w-auto px-6 py-3 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-colors duration-200 ease-in-out"
                                        >
                                            Close story
                                        </button>
                                    </div>
                                </section>
                            </article>
                        </template>
                    </template>
                    <div x-show="stories.length > 0 && currentCategory !== 'OnThisDay' && !stories.every(story => readStories[story.title])" class="mt-6 w-full text-center">
                        <button
                            @click="markAllAsRead(); window.scrollTo({ top: 0, behavior: 'smooth' })"
                            class="w-full md:w-auto px-6 py-3 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200"
                        >
                            Mark all as read
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <div x-show="showSourceOverlay" x-cloak @open-source.window="processSource($event)" @click.self="showSourceOverlay = false" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center p-4 z-[70]">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <header class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-2">
                        <img :src="currentSource?.favicon || '{{ static_path }}/svg/placeholder.svg'" :alt="currentSource?.name ? `${currentSource.name} favicon` : 'Generic favicon'" class="w-6 h-6" />
                        <h3 class="text-xl font-bold dark:text-dark-text" x-text="currentSource?.name || 'Unknown Source'"></h3>
                    </div>
                    <button @click="showSourceOverlay = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </header>
                <p class="text-gray-600 dark:text-gray-400 mb-4" x-text="(sourceArticles || []).length + ' articles'"></p>
                <div class="space-y-4">
                    <template x-for="article in sourceArticles" :key="article.link">
                        <article class="flex space-x-4">
                            <img x-bind:src="article.image || '{{ static_path }}/svg/placeholder.svg'" alt="Article image" class="w-24 h-24 object-cover rounded" />
                            <div>
                                <a :href="article.link" target="_blank" rel="noopener noreferrer" class="hover:underline" @click.stop>
                                    <h4 class="font-semibold dark:text-dark-text" x-text="article.title"></h4>
                                </a>
                                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="new Date(article.date).toLocaleString()"></p>
                            </div>
                        </article>
                    </template>
                </div>

                <!-- Source Information -->
                <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <button @click="showSourceInfo = !showSourceInfo" class="w-full flex justify-between items-center text-left text-gray-800 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded-lg">
                        <span class="font-semibold">Source information</span>
                        <svg class="w-5 h-5 transform transition-transform" :class="{'rotate-180': showSourceInfo}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <div x-show="showSourceInfo" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform -translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" class="mt-4">
                        <!-- Show this when media info exists -->
                        <template x-if="mediaInfo">
                            <div class="grid md:grid-cols-3 gap-6">
                                <!-- Left Column -->
                                <div class="space-y-4 col-span-1">
                                    <!-- Country -->
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"
                                            />
                                        </svg>
                                        <div>
                                            <div class="font-medium text-gray-700 dark:text-gray-300">Country</div>
                                            <div class="text-gray-600 dark:text-gray-400" x-text="mediaInfo.country"></div>
                                        </div>
                                    </div>

                                    <!-- Owner -->
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                        </svg>
                                        <div>
                                            <div class="font-medium text-gray-700 dark:text-gray-300">Owner</div>
                                            <div class="text-gray-600 dark:text-gray-400" x-text="mediaInfo.owner || 'Not specified'"></div>
                                        </div>
                                    </div>

                                    <!-- Organization -->
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                                            />
                                        </svg>
                                        <div>
                                            <div class="font-medium text-gray-700 dark:text-gray-300">Organization</div>
                                            <div class="text-gray-600 dark:text-gray-400" x-text="mediaInfo.organization"></div>
                                        </div>
                                    </div>

                                    <!-- Media Classification -->
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <div>
                                            <div class="font-medium text-gray-700 dark:text-gray-300">Media Classification</div>
                                            <div class="text-gray-600 dark:text-gray-400" x-text="mediaInfo.typology"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column -->
                                <div class="space-y-4 col-span-2">
                                    <!-- Description -->
                                    <div x-show="mediaInfo.description" class="text-gray-700 dark:text-gray-300">
                                        <h4 class="font-medium mb-2">Description</h4>
                                        <p x-text="mediaInfo.description"></p>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Show this when no media info exists -->
                        <template x-if="!mediaInfo">
                            <div class="text-center py-6">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Help improve our database</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">
                                    We don't have detailed information about this news source yet. Your contribution can help others stay informed about media ownership and bias.
                                </p>
                                <a href="https://github.com/kagisearch/kite-public" class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200">
                                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path
                                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                                        />
                                    </svg>
                                    Contribute Information
                                </a>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Overlay -->
        <div
            x-data
            x-show="$store.settings.isOpen"
            x-cloak
            role="complementary"
            aria-label="Settings panel"
            class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-[80]"
            @click.self="$store.settings.close()"
            @keydown.escape.window="$store.settings.close()"
        >
            <div class="bg-white dark:bg-gray-800 w-full h-full md:rounded-lg md:p-8 md:max-w-[42rem] md:h-auto md:max-h-[90vh] shadow-xl overflow-y-auto flex flex-col" @click.stop x-data="{ activeTab: 'general' }">
                <header class="flex-shrink-0 bg-white dark:bg-gray-800 p-4 md:p-0">
                    <div class="flex justify-end mb-1">
                        <button @click="$store.settings.close()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200 dark:border-gray-700">
                        <button 
                            @click="activeTab = 'general'"
                            :class="{'border-blue-500 text-blue-600 dark:text-blue-400': activeTab === 'general',
                                    'border-transparent text-gray-500 dark:text-gray-400': activeTab !== 'general'}"
                            class="px-4 py-2 border-b-2 font-medium text-sm"
                        >
                            General
                        </button>
                        <button 
                            @click="activeTab = 'categories'"
                            :class="{'border-blue-500 text-blue-600 dark:text-blue-400': activeTab === 'categories',
                                    'border-transparent text-gray-500 dark:text-gray-400': activeTab !== 'categories'}"
                            class="px-4 py-2 border-b-2 font-medium text-sm"
                        >
                            Categories
                        </button>
                        <button 
                            @click="activeTab = 'sections'"
                            :class="{'border-blue-500 text-blue-600 dark:text-blue-400': activeTab === 'sections',
                                    'border-transparent text-gray-500 dark:text-gray-400': activeTab !== 'sections'}"
                            class="px-4 py-2 border-b-2 font-medium text-sm"
                        >
                            Sections
                        </button>
                    </div>
                </header>
                <div class="p-4 md:p-0 mt-6">
                    <!-- General Settings Tab -->
                    <div x-show="activeTab === 'general'" class="space-y-6">
                        <div class="flex flex-col space-y-2">
                            <label for="theme-select" class="text-sm font-medium text-gray-700 dark:text-gray-300">Theme</label>
                            <div class="relative">
                                <select
                                    id="theme-select"
                                    x-model="$store.theme.current"
                                    @change="$store.theme.set($event.target.value)"
                                    aria-label="Select theme preference"
                                    class="block appearance-none w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
                                >
                                    <option value="system">System</option>
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <label for="language-select" class="text-sm font-medium text-gray-700 dark:text-gray-300">Language</label>
                            <div class="relative">
                                <select
                                    id="language-select"
                                    x-model="$store.language.current"
                                    @change="$store.language.set($event.target.value)"
                                    aria-label="Select language"
                                    class="block appearance-none w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
                                >
                                    <option value="en">Default</option>
                                    <option value="en">English (English)</option>
                                    <option value="pt">Portugus (Portuguese)</option>
                                    <option value="it">Italiano (Italian)</option>
                                    <option value="fr">Franais (French)</option>
                                    <option value="es">Espaol (Spanish)</option>                                    
                                    <option value="de">Deutsch (German)</option>
                                    <option value="zh"> (Chinese)</option>
                                    <option value="ja"> (Japanese)</option>
                                    <option value="hi"> (Hindi)</option>
                                 </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile-only category header position setting -->
                        <div class="flex flex-col space-y-2 md:hidden">
                            <label for="category-header-position" class="text-sm font-medium text-gray-700 dark:text-gray-300">Category Header Position</label>
                            <div class="relative">
                                <select
                                    id="category-header-position"
                                    x-model="$store.mobileUI.categoryHeaderPosition"
                                    @change="$store.mobileUI.setCategoryHeaderPosition($event.target.value)"
                                    aria-label="Select category header position"
                                    class="block appearance-none w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
                                >
                                    <option value="bottom">Bottom</option>
                                    <option value="top">Top</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Choose where to display the category navigation bar on mobile devices.</p>
                        </div>
                        

                        <div class="flex flex-col space-y-2">
                            <label for="font-size-select" class="text-sm font-medium text-gray-700 dark:text-gray-300">Font size</label>
                            <div class="relative">
                                <select
                                    id="font-size-select"
                                    x-model="$store.fontSize.current"
                                    @change="$store.fontSize.set($event.target.value)"
                                    aria-label="Select text size"
                                    class="block appearance-none w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
                                >
                                    <option value="small">Small</option>
                                    <option value="normal">Normal</option>
                                    <option value="large">Large</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <label for="story-count-range" class="text-sm font-medium text-gray-700 dark:text-gray-300"> Number of stories shown: <span x-text="$store.storyCount.current"></span> </label>
                            <input
                                id="story-count-range"
                                type="range"
                                min="3"
                                max="12"
                                x-model="$store.storyCount.current"
                                @input="$store.storyCount.set($event.target.value); changeCategory()"
                                @mousedown="lockScroll"
                                @mouseup="unlockScroll"
                                @touchstart="lockScroll"
                                @touchend="unlockScroll"
                                aria-label="Adjust number of stories shown"
                                aria-valuemin="3"
                                aria-valuemax="12"
                                :aria-valuenow="$store.storyCount.current"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                            />
                        </div>
                        
                        <div class="flex flex-col space-y-2">
                            <button
                                @click="$store.settings.close(); showIntro = true; updateUrlWithArticleId('')"
                                class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200 text-sm font-medium flex items-center justify-center space-x-2"
                            >
                                <img :src="$store.theme.current === 'dark' ? '{{ static_path }}/svg/kite_dark.svg' : '{{ static_path }}/svg/kite.svg'" alt="Kite icon" class="h-4 w-4" />
                                <span>About Kite</span>
                            </button>
                        </div>

                    </div>
                    <!-- Categories Tab -->
                    <div x-show="activeTab === 'categories'" class="space-y-6">
                        <div class="flex flex-col space-y-2">
                            <p class="text-xs text-gray-500 dark:text-gray-400">Tap to toggle. Drag enabled categories to reorder.</p>

                            <!-- Enabled categories container -->
                            <div x-ref="enabledCategories" class="flex flex-wrap gap-2 mb-4"></div>

                            <!-- Separator -->
                            <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>

                            <!-- Disabled categories container -->
                            <div x-ref="disabledCategories" class="flex flex-wrap gap-2"></div>

                            <!-- Contribute link -->
                            <div class="flex justify-center mt-4">
                                <a href="https://github.com/kagisearch/kite-public" class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 text-sm">
                                    + Contribute categories
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Sections Tab -->
                    <div x-show="activeTab === 'sections'" class="space-y-6">
                        <div class="flex flex-col space-y-4" x-ref="sectionsList" x-init="$store.sections.render()"></div>
                        <!-- Reset button -->
                        <div class="flex justify-center mt-4">
                            <button @click="$store.sections.reset()" 
                                    class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 text-sm">
                                Reset order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-4 mt-8">
            <div class="container mx-auto px-4 max-w-[732px] flex justify-center items-center space-x-6">
                <a
                    href="https://github.com/kagisearch/kite-public" 
                    target="_blank" 
                    title="Contribute to Kagi News" 
                    class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 flex items-center space-x-2"
                >
                    <svg class="h-5 w-5 text-gray-600 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    <span class="text-sm">Contribute</span>
                </a>
                <a
                    :href="currentCategory === 'OnThisDay' ? 
                        `https://en.wikipedia.org/w/api.php?action=featuredfeed&feed=onthisday&lang=${$store.language.current}` : 
                        `${currentCategory.toLowerCase()}.xml`"
                    target="_blank"
                    class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 flex items-center space-x-2"
                    title="RSS feed"
                >
                    <img src="{{ static_path }}/svg/rss.svg" alt="" class="h-5 w-5 dark:invert" aria-hidden="true" />
                    <span class="text-sm">RSS Feed</span>
                </a>
            </div>
        </footer>
        
    </body>
</html>
